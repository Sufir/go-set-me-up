name: Run tests

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    env:
      COVERAGE_EXCLUDE: |
        (^|/)test[^/]*(/|$)
        (^|/)[^/]test\.go$
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download modules
        run: go mod download

      - name: Run tests with coverage
        run: |
          set -e
          go test ./... -covermode=atomic -coverprofile=coverage.out

      - name: Filter coverage excludes
        id: filter
        run: |
          set -e
          src="coverage.out"
          excludes="${COVERAGE_EXCLUDE}"
          header=$(head -n 1 "$src")
          tail -n +2 "$src" > coverage.body
          ws="$GITHUB_WORKSPACE"
          pats=$(printf "%s" "$excludes" | tr '\n' '\t')
          awk -v ws="$ws" -v pats="$pats" '
            BEGIN { n=split(pats, a, "\t") }
            {
              line=$0
              i=index(line, ":")
              path=(i>0?substr(line,1,i-1):line)
              rel=path
              prefix=ws "/"
              if (ws != "" && index(path, prefix)==1) {
                rel=substr(path, length(prefix)+1)
              }
              skip=0
              if (n>0) {
                for (j=1;j<=n;j++) {
                  p=a[j]; if (p=="") continue
                  if (rel ~ p) { skip=1; break }
                }
              }
              if (skip==0) print line
            }
          ' coverage.body > coverage.filtered.body
          printf "%s\n" "$header" > coverage.filtered.out
          cat coverage.filtered.body >> coverage.filtered.out
          selected="$src"
          if [ -s coverage.filtered.out ]; then selected="coverage.filtered.out"; fi
          echo "selected=$selected" >> "$GITHUB_OUTPUT"

      - name: Compute coverage value
        id: cov
        run: |
          set -e
          src="${{ steps.filter.outputs.selected }}"
          if [ -z "$src" ]; then src="coverage.out"; fi
          if [ ! -s "$src" ]; then
            echo "coverage.out not found or empty" >&2
            exit 1
          fi
          pct=$(go tool cover -func="$src" | awk '/^[[:space:]]*total:/ {print $NF}' | tr -d '%')
          if [ -z "$pct" ]; then
            echo "Failed to parse total coverage, dumping cover func output for debug:" >&2
            go tool cover -func="$src" || true
            pct="0"
          fi
          echo "pct=$pct" >> "$GITHUB_OUTPUT"

          val=${pct%.*}
          if [ -z "$val" ]; then val=0; fi
          if   [ "$val" -ge 80 ]; then color=brightgreen
          elif [ "$val" -ge 70 ]; then color=green
          elif [ "$val" -ge 60 ]; then color=yellowgreen
          elif [ "$val" -ge 50 ]; then color=yellow
          else color=red
          fi
          echo "color=$color" >> "$GITHUB_OUTPUT"

      - name: Write Shields endpoint JSON
        run: |
          pct="${{ steps.cov.outputs.pct }}"
          color="${{ steps.cov.outputs.color }}"
          branch="${{ github.ref_name }}"
          mkdir -p "./.pages/${branch}"
          cat <<EOF > "./.pages/${branch}/coverage-badge.json"
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${pct}%",
            "color": "${color}",
            "cacheSeconds": 60
          }
          EOF
          mkdir -p ./.pages
          cp "./.pages/${branch}/coverage-badge.json" "./.pages/coverage-badge.json"

      - name: Generate HTML coverage report
        run: |
          branch="${{ github.ref_name }}"
          src="${{ steps.filter.outputs.selected }}"
          if [ -z "$src" ]; then src="coverage.out"; fi
          mkdir -p "./.pages/${branch}"
          go tool cover -html="$src" -o "./.pages/${branch}/index.html"
          mkdir -p ./.pages
          cp "./.pages/${branch}/index.html" "./.pages/index.html"

      - name: Upload Pages artifact
        if: github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages
          path: ./.pages

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push'
        uses: actions/deploy-pages@v4

  
