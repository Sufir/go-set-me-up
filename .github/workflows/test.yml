name: Tests and Coverage

on:
  push:
    branches: [main, master, dev]
  pull_request:
    branches: [main, master, dev]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  tests:
    name: Run tests and publish coverage artifact
    runs-on: ubuntu-latest
    environment: github-pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download modules
        run: go mod download

      - name: Run tests with coverage
        run: |
          set -e
          go test ./... -covermode=atomic -coverprofile=coverage.out

      - name: Compute coverage value
        id: cov
        run: |
          set -e
          if [ ! -s coverage.out ]; then
            echo "coverage.out not found or empty" >&2
            exit 1
          fi
          pct=$(go tool cover -func=coverage.out | awk '/^[[:space:]]*total:/ {print $NF}' | tr -d '%')
          if [ -z "$pct" ]; then
            echo "Failed to parse total coverage, dumping cover func output for debug:" >&2
            go tool cover -func=coverage.out || true
            pct="0"
          fi
          echo "pct=$pct" >> "$GITHUB_OUTPUT"

          val=${pct%.*}
          if [ -z "$val" ]; then val=0; fi
          if   [ "$val" -ge 80 ]; then color=brightgreen
          elif [ "$val" -ge 70 ]; then color=green
          elif [ "$val" -ge 60 ]; then color=yellowgreen
          elif [ "$val" -ge 50 ]; then color=yellow
          else color=red
          fi
          echo "color=$color" >> "$GITHUB_OUTPUT"

      - name: Write Shields endpoint JSON
        run: |
          pct="${{ steps.cov.outputs.pct }}"
          color="${{ steps.cov.outputs.color }}"
          mkdir -p ./.pages
          cat <<EOF > ./.pages/coverage-badge.json
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${pct}%",
            "color": "${color}",
            "cacheSeconds": 60
          }
          EOF

      - name: Generate HTML coverage report
        run: |
          mkdir -p ./.pages
          go tool cover -html=coverage.out -o ./.pages/index.html

      - name: Upload Pages artifact
        if: >
          github.event_name == 'push' &&
          (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev')
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages
          path: ./.pages

      - name: Deploy to GitHub Pages
        if: >
          github.event_name == 'push' &&
          (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev')
        uses: actions/deploy-pages@v4
