name: Tests and Coverage

on:
  push:
    branches: [main, master, dev]
  pull_request:
    branches: [main, master, dev]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  statuses: write
  issues: write

jobs:
  tests:
    name: Run tests and publish coverage artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download modules
        run: go mod download

      - name: Run tests with coverage
        run: |
          set -e
          go test ./... -covermode=atomic -coverprofile=coverage.out

      - name: Compute coverage value
        id: cov
        run: |
          set -e
          if [ ! -s coverage.out ]; then
            echo "coverage.out not found or empty" >&2
            exit 1
          fi
          pct=$(go tool cover -func=coverage.out | awk '/^[[:space:]]*total:/ {print $NF}' | tr -d '%')
          if [ -z "$pct" ]; then
            echo "Failed to parse total coverage, dumping cover func output for debug:" >&2
            go tool cover -func=coverage.out || true
            pct="0"
          fi
          echo "pct=$pct" >> "$GITHUB_OUTPUT"

          val=${pct%.*}
          if [ -z "$val" ]; then val=0; fi
          if   [ "$val" -ge 80 ]; then color=brightgreen
          elif [ "$val" -ge 70 ]; then color=green
          elif [ "$val" -ge 60 ]; then color=yellowgreen
          elif [ "$val" -ge 50 ]; then color=yellow
          else color=red
          fi
          echo "color=$color" >> "$GITHUB_OUTPUT"

      - name: Write Shields endpoint JSON
        run: |
          pct="${{ steps.cov.outputs.pct }}"
          color="${{ steps.cov.outputs.color }}"
          mkdir -p ./.pages
          cat <<EOF > ./.pages/coverage-badge.json
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${pct}%",
            "color": "${color}",
            "cacheSeconds": 60
          }
          EOF

      - name: Generate HTML coverage report
        run: |
          mkdir -p ./.pages
          go tool cover -html=coverage.out -o ./.pages/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages
          path: ./.pages

      - name: Checkout base branch
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Run base tests with coverage
        if: github.event_name == 'pull_request'
        working-directory: base
        run: |
          set -e
          go mod download
          go test ./... -covermode=atomic -coverprofile=coverage.out

      - name: Compute base coverage value
        if: github.event_name == 'pull_request'
        id: basecov
        working-directory: base
        run: |
          set -e
          if [ ! -s coverage.out ]; then
            echo "coverage.out not found or empty" >&2
            exit 1
          fi
          pct=$(go tool cover -func=coverage.out | awk '/^[[:space:]]*total:/ {print $NF}' | tr -d '%')
          if [ -z "$pct" ]; then
            echo "Failed to parse total coverage, dumping cover func output for debug:" >&2
            go tool cover -func=coverage.out || true
            pct="0"
          fi
          echo "pct=$pct" >> "$GITHUB_OUTPUT"

      - name: Compute coverage delta
        if: github.event_name == 'pull_request'
        id: covdelta
        run: |
          set -e
          pct="${{ steps.cov.outputs.pct }}"
          base="${{ steps.basecov.outputs.pct }}"
          if [ -z "$pct" ] || [ -z "$base" ]; then
            echo "delta=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          delta=$(awk "BEGIN {printf \"%.2f\", $pct - $base}")
          sign=""
          awk "BEGIN {exit !($delta > 0)}" && sign="+" || true
          echo "delta=$sign$delta" >> "$GITHUB_OUTPUT"

      - name: Publish coverage summary
        if: github.event_name == 'pull_request'
        run: |
          pct="${{ steps.cov.outputs.pct }}"
          base="${{ steps.basecov.outputs.pct }}"
          delta="${{ steps.covdelta.outputs.delta }}"
          {
            echo "Coverage: ${pct}%"
            echo "Base: ${base}%"
            if [ -n "$delta" ]; then echo "Δ: ${delta}%"; fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Post coverage commit status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pct = `${{ steps.cov.outputs.pct }}`;
            const delta = `${{ steps.covdelta.outputs.delta }}`;
            const sha = context.payload.pull_request.head.sha;
            const desc = (delta && delta.length > 0) ? `Coverage ${pct}% (Δ ${delta}%)` : `Coverage ${pct}%`;
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha,
              state: 'success',
              context: 'coverage',
              description: desc
            });

      - name: Create or update PR coverage comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pct = `${{ steps.cov.outputs.pct }}`;
            const base = `${{ steps.basecov.outputs.pct }}`;
            const delta = `${{ steps.covdelta.outputs.delta }}`;
            const number = context.payload.pull_request.number;
            const header = 'Coverage Report';
            const body = [
              `### ${header}`,
              `Coverage: ${pct}%`,
              `Base: ${base}%`,
              delta ? `Δ: ${delta}%` : ''
            ].filter(Boolean).join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number
            });
            const botComment = comments.find(c => c.user.type === 'Bot' && c.body && c.body.startsWith(`### ${header}`));
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body
              });
            }

  deploy_coverage:
    needs: tests
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Evaluate deploy conditions
        id: eval
        run: |
          set -e
          should=false
          if [ "${{ github.event_name }}" = "push" ]; then
            case "${{ github.ref }}" in
              refs/heads/main|refs/heads/master|refs/heads/dev) should=true ;;
            esac
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.merged }}" = "true" ] && [ "${{ github.base_ref }}" = "dev" ]; then
            should=true
          fi
          echo "should_deploy=$should" >> "$GITHUB_OUTPUT"

      - name: Skip deploy on this event
        if: steps.eval.outputs.should_deploy != 'true'
        run: echo "Deployment skipped for event=${{ github.event_name }} ref=${{ github.ref }} base=${{ github.base_ref }}"

      - name: Deploy to GitHub Pages
        if: steps.eval.outputs.should_deploy == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
